--cua1: tao user--
CREATE TABLE BTKHDL1.XE(
MAXE VARCHAR2(3),
BIENKS VARCHAR2(9),
MATUYEN VARCHAR2 (4),
SOGHET1 NUMBER ,
SOGHET2 NUMBER ,

CONSTRAINT PK_XE PRIMARY KEY (MAXE)
);


CREATE TABLE BTKHDL1.TUYEN(
MATUYEN VARCHAR2(4),
BENDAU VARCHAR2(2),
BENCUOI VARCHAR2 (3),
GIATUYEN NUMBER ,
NGXB DATE, 
TGDK NUMBER,

CONSTRAINT PK_TUYEN PRIMARY KEY (MATUYEN)
);



CREATE TABLE BTKHDL1.KHACH(
    MAHK        VARCHAR2(4),
    HOTEN       NVARCHAR2(50),
    GIOITINH    NVARCHAR2(10),
    CMND        VARCHAR2(15),
    
    CONSTRAINT PK_KHACH PRIMARY KEY(MAHK)
);

CREATE TABLE BTKHDL1.VEXE(
MATUYEN VARCHAR2(4),
MAHK  VARCHAR2(4),
NGMUA DATE ,
GIAVE NUMBER 

);
--tao khoa ngoai--
ALTER TABLE XE 
ADD CONSTRAINT FK_XE_TUYEN
    FOREIGN KEY (MATUYEN)
    REFERENCES TUYEN (MATUYEN);

ALTER TABLE VEXE 
ADD CONSTRAINT FK_VEXE_TUYEN
    FOREIGN KEY (MATUYEN)
    REFERENCES TUYEN (MATUYEN);
    
ALTER TABLE VEXE 
ADD CONSTRAINT FK_VEXE_HK
    FOREIGN KEY (MAHK)
    REFERENCES KHACH (MAHK);
    
--CAU2: NHAP DU LIEU
--TUYEN--
INSERT INTO TUYEN VALUES ('T11A','SG','DL', 210.000,To_Date('26/12/2016','dd/mm/yyyy'), 6);
INSERT INTO TUYEN VALUES ('T32D','PT','SG',120.000,To_Date('30/12/2016','dd/mm/yyyy'), 4);
INSERT INTO TUYEN VALUES ('T06F', 'NT', 'DNG', 225.000, To_Date('02/01/2017','dd/mm/yyyy'), 7);

--XE--
INSERT INTO XE VALUES ('X01', '52LD-4393' ,'T11A', 20,20);
INSERT INTO XE VALUES ('X02', '59LD-7247','T32D', 36 ,36);
INSERT INTO XE VALUES ('X03', '55LD-6850','T06F', 15,15);
--KHACH--
INSERT INTO KHACH VALUES ('KH01','Lam Van Ben','Nam', '655615896');
INSERT INTO KHACH VALUES ('KH02', 'Duong Thi Luc','Nu', '275648642');
INSERT INTO KHACH VALUES ('KH03' ,'Hoang Thanh Tung', 'Nam', '456889143');
--VEXE
INSERT INTO VEXE VALUES ('T11A', 'KH01', To_Date('20/12/2016','dd/mm/yyyy'), 210.000);
INSERT INTO VEXE VALUES ('T32D' ,'KH02', To_Date('25/12/2016','dd/mm/yyyy'), 144.000);
INSERT INTO VEXE VALUES ('T06F', 'KH03', To_Date('30/12/2016','dd/mm/yyyy'),270.000);

--CAU3--
--HIEN THUC RANG BUOC TOAN VEN: Cac tuyen xe co thoi gian du kien lon hon 5 tieng luon co gia tuyen lon hon 200.000--
ALTER TABLE TUYEN
ADD CONSTRAINT KTR_GIA_TGDK
CHECK ((TGDK >5 AND GIATUYEN >200.000) OR TGDK <=5);

INSERT INTO TUYEN VALUES ('T11B','SG','DL', 210.000,To_Date('26/12/2016','dd/mm/yyyy'), 6);

DELETE FROM TUYEN
WHERE MATUYEN='T11B';
--CAU4--
--Tuyen xe co NGXB 29/12/2016 -> 05/01/2017 tang GIAVE 5%

--CAU5--
--TIM tat VEXE mua trong thang 12, SAP XEP GIAM DAN theo GIAVE--

SELECT * 
FROM VEXE
WHERE  EXTRACT(MONTH FROM NGMUA) =12
ORDER BY GIAVE DESC;

--CAU7--
--TUYEN có KHACHHANG là NAM Va NU (GIAO)--
--them data de kiem tra--
INSERT INTO KHACH VALUES ('KH04' ,'Hoang Thanh ', 'Nu', '456889142');
INSERT INTO VEXE VALUES ('T11A', 'KH04', To_Date('20/12/2016','dd/mm/yyyy'), 210.000);

SELECT *
FROM TUYEN T1
WHERE T1.MATUYEN= (
    SELECT T.MATUYEN
        FROM TUYEN T 
        INNER JOIN VEXE VX ON T.MATUYEN=VX.MATUYEN 
        INNER JOIN KHACH K ON K.MAHK=VX.MAHK
        WHERE GIOITINH='Nam' 
    INTERSECT
    SELECT T.MATUYEN
        FROM TUYEN T 
        INNER JOIN VEXE VX ON T.MATUYEN=VX.MATUYEN 
        INNER JOIN KHACH K ON K.MAHK=VX.MAHK
        WHERE GIOITINH='Nu' );
--CAU8--
--TIM HANHKHACH gioi tinh: NU DA TUNG mua ve tat ca cac tuyen xe--
--PHEP CHIA--

--them du lieu de kiem tra--
INSERT INTO VEXE VALUES ('T32D' ,'KH04', To_Date('25/12/2016','dd/mm/yyyy'), 144.000);
INSERT INTO VEXE VALUES ('T06F', 'KH04', To_Date('30/12/2016','dd/mm/yyyy'),270.000);

SELECT *
FROM KHACH K
WHERE GIOITINH='Nu' AND NOT EXISTS
    ( SELECT * 
        FROM TUYEN T
        WHERE NOT EXISTS
        (SELECT *
            FROM VEXE VX
            WHERE VX.MATUYEN = T.MATUYEN AND
                 VX.MAHK=K.MAHK));

--CAU6--
--TIM TUYEN XE co so ve it nhat name 2016--
 
 select * 
 from TUYEN T
 WHERE T.MATUYEN IN
        (SELECT VX1.MATUYEN
            FROM VEXE VX1
            WHERE EXTRACT(YEAR FROM VX1.NGMUA)=2016
            GROUP BY VX1.MATUYEN
            HAVING COUNT(VX1.MATUYEN) <= ALL ( SELECT COUNT(VX2.MATUYEN)
                                        FROM VEXE VX2
                                        WHERE EXTRACT(YEAR FROM VX2.NGMUA)=2016
                                        GROUP BY VX2.MATUYEN));
                                        
        
    
   
                 
                 
            
            





